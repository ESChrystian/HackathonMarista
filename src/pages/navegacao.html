<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roteiro Inteligente - Navega칞칚o</title>

    <link rel="stylesheet" href="/src/styles/nav.css">

    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
</head>

<body>

    <div id="map"></div>

    <div class="status-box" id="statusBox">
        <div class="header">
            <h3>Navega칞칚o Tur칤stica na Regi칚o Norte</h3>
        </div>
        <div class="title">Pr칩ximo destino:</div>
        <div id="destinoAtual">Carregando...</div>
        <small id="distanciaAtual"></small>
    </div>

    <!-- Bot칚o para abrir/fechar o modal -->
    <button class="toggle-modal-btn" id="toggleModalBtn">游늶</button>

    <!-- Modal de pontos selecionados -->
    <div class="points-modal" id="pointsModal">
        <div class="points-modal-header">
            <div class="points-modal-title">Pontos Selecionados</div>
            <button class="points-modal-close" id="closeModalBtn">&times;</button>
        </div>
        <div class="points-list" id="pointsList">
            <!-- Os pontos ser칚o inseridos aqui dinamicamente -->
        </div>
    </div>

    <script>
        // Pegando locais selecionados
        let locais = JSON.parse(localStorage.getItem("selecionados")) || [];

        let atual = 0; // 칤ndice do ponto atual
        let conclu칤dos = [];
        let userLat = null;
        let userLng = null;

        const statusBox = document.getElementById("statusBox");
        const destinoAtualEl = document.getElementById("destinoAtual");
        const distanciaAtualEl = document.getElementById("distanciaAtual");
        const toggleModalBtn = document.getElementById("toggleModalBtn");
        const pointsModal = document.getElementById("pointsModal");
        const closeModalBtn = document.getElementById("closeModalBtn");
        const pointsList = document.getElementById("pointsList");

        // Criar mapa
        const map = L.map('map').setView([-23.31, -51.17], 14);

        // Camada do mapa
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19
        }).addTo(map);

        // 칈cone personalizado tipo Uber
        const iconDestino = L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
            iconSize: [40, 40]
        });

        // 칈cone usu치rio
        const iconUser = L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/428/428933.png",
            iconSize: [40, 40]
        });

        // Criar marcadores dos destinos
        let markers = locais.map(loc => {
            return L.marker([loc.lat, loc.lng], { icon: iconDestino })
                .addTo(map)
                .bindPopup(`<b>${loc.nome}</b><br>${loc.descricao}`);
        });

        // ------------------------------
        // FUN칂칏ES DE DIST츽NCIA
        // ------------------------------
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI/180;
            const dLon = (lon2 - lon1) * Math.PI/180;

            const a =
                Math.sin(dLat/2) ** 2 +
                Math.cos(lat1 * Math.PI/180) *
                Math.cos(lat2 * Math.PI/180) *
                Math.sin(dLon/2) ** 2;

            return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))) * 1000; // metros
        }

        // Ordenar locais pela dist칙ncia do usu치rio
        function ordenarLocais(lat, lng) {
            locais.sort((a, b) => {
                const distA = getDistance(lat, lng, a.lat, a.lng);
                const distB = getDistance(lat, lng, b.lat, b.lng);
                return distA - distB;
            });

            // Atualizar marcadores conforme nova ordem
            markers.forEach(m => map.removeLayer(m));
            markers = locais.map(loc =>
                L.marker([loc.lat, loc.lng], { icon: iconDestino })
                    .addTo(map)
                    .bindPopup(`<b>${loc.nome}</b><br>${loc.descricao}`)
            );

            // Atualizar o modal ap칩s ordenar
            atualizarModalPontos();
        }

        // ------------------------------
        // DESENHAR ROTA ENTRE OS LOCAIS
        // ------------------------------
        let rotaPolyline = null;

        function desenharRota() {
            if (rotaPolyline) map.removeLayer(rotaPolyline);

            const coords = locais.map(l => [l.lat, l.lng]);

            rotaPolyline = L.polyline(coords, {
                color: "blue",
                weight: 6,
                opacity: 0.7
            }).addTo(map);

            map.fitBounds(rotaPolyline.getBounds());
        }

        // ------------------------------
        // DESTINO ATUAL
        // ------------------------------
        function atualizarDestino() {
            if (atual >= locais.length) {
                destinoAtualEl.textContent = "Todos os locais conclu칤dos! 游꿀";
                distanciaAtualEl.textContent = "";
                return;
            }

            destinoAtualEl.textContent = locais[atual].nome;
        }
        atualizarDestino();

        // ------------------------------
        // MODAL DE PONTOS SELECIONADOS
        // ------------------------------
        function atualizarModalPontos() {
            pointsList.innerHTML = '';
            
            locais.forEach((local, index) => {
                const pointItem = document.createElement('div');
                pointItem.className = 'point-item';
                
                const pointInfo = document.createElement('div');
                pointInfo.className = 'point-info';
                
                const pointName = document.createElement('div');
                pointName.className = 'point-name';
                pointName.textContent = local.nome;
                
                const pointDistance = document.createElement('div');
                pointDistance.className = 'point-distance';

                // Calcular dist칙ncia se temos a localiza칞칚o do usu치rio
                if (userLat && userLng) {
                    const distancia = getDistance(userLat, userLng, local.lat, local.lng);
                    pointDistance.textContent = `${(distancia/1000).toFixed(2)} km`;
                } else {
                    pointDistance.textContent = 'Calculando...';
                }
                
                pointInfo.appendChild(pointName);
                pointInfo.appendChild(pointDistance);
                
                const pointStatus = document.createElement('div');
                pointStatus.className = 'point-status';
                
                // Determinar o status do ponto
                if (conclu칤dos.includes(local)) {
                    pointStatus.textContent = 'Conclu칤do';
                    pointStatus.classList.add('status-completed');
                } else if (index === atual) {
                    pointStatus.textContent = 'Atual';
                    pointStatus.classList.add('status-current');
                } else {
                    pointStatus.textContent = 'Pendente';
                    pointStatus.classList.add('status-pending');
                }
                
                pointItem.appendChild(pointInfo);
                pointItem.appendChild(pointStatus);
                pointsList.appendChild(pointItem);
            });
        }

        // ------------------------------
        // CONTROLE DO MODAL
        // ------------------------------
        toggleModalBtn.addEventListener('click', () => {
            if (pointsModal.style.display === 'block') {
                pointsModal.style.display = 'none';
            } else {
                pointsModal.style.display = 'block';
                atualizarModalPontos();
            }
        });

        closeModalBtn.addEventListener('click', () => {
            pointsModal.style.display = 'none';
        });

        // Fechar modal ao clicar fora dele
        document.addEventListener('click', (event) => {
            if (!pointsModal.contains(event.target) && event.target !== toggleModalBtn) {
                pointsModal.style.display = 'none';
            }
        });

        // ------------------------------
        // RASTREAMENTO DO USU츼RIO
        // ------------------------------
        let userMarker = null;
        let primeiraLocalizacao = true;

        navigator.geolocation.watchPosition(pos => {
            userLat = pos.coords.latitude;
            userLng = pos.coords.longitude;

            // Atualizar posi칞칚o do usu치rio
            if (!userMarker) {
                userMarker = L.marker([userLat, userLng], { icon: iconUser }).addTo(map);
            } else {
                userMarker.setLatLng([userLat, userLng]);
            }

            map.setView([userLat, userLng]);

            // Ordena os locais somente na primeira localiza칞칚o
            if (primeiraLocalizacao) {
                ordenarLocais(userLat, userLng);
                primeiraLocalizacao = false;
            }

            // Dist칙ncia para o pr칩ximo ponto
            const destino = locais[atual];
            const dist = getDistance(userLat, userLng, destino.lat, destino.lng);

            distanciaAtualEl.textContent = `Dist칙ncia: ${(dist/1000).toFixed(2)} km`;

            // Atualizar o modal com as dist칙ncias atualizadas
            atualizarModalPontos();

            // Se estiver perto, concluir
            if (dist < 80) {
                markers[atual].bindPopup(`<b>${destino.nome}</b><br>九덢잺 Conclu칤do`).openPopup();
                conclu칤dos.push(destino);
                atual++;
                atualizarDestino();

                // Atualizar o modal ap칩s concluir um ponto
                atualizarModalPontos();

                // Efeito visual
                gsap.fromTo(statusBox, { scale: 1 }, { scale: 1.08, duration: 0.3, yoyo: true, repeat: 1 });
            }

        }, () => {
            alert("Voc칡 precisa permitir o GPS para navegar pelos pontos tur칤sticos.");
        });

        // Inicializar o modal
        atualizarModalPontos();
    </script>
</body>
</html>