<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roteiro Inteligente - Navega√ß√£o</title>

    <style>
        :root{
            --BG: #f3f0d1;
            --primari: #A20E0E;
            --secundari: #C85108;
            --terceari: #E29C68;
            --font-primary:Helvetica;
        }

        h1, h2 {
            font-family: var(--font-primary);
        }

        #map {
            height: 92vh;
            width: 100%;
        }

        .status-box {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primari);
            color: var(--BG);
            padding: 12px 15px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            font-family: Arial;
            font-size: 0.95rem;
            width: 90%;
            max-width: 380px;
            z-index: 1000;
        }

        .status-box .header h3 {
            margin: 0 0 8px 0;
            font-size: 1rem;
        }

        .status-box .title {
            font-weight: bold;
            margin-bottom: 6px;
        }

        /* Modal de pontos selecionados */
        .points-modal {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            font-family: Arial;
            display: none;
        }

        .points-modal-header {
            padding: 12px 15px;
            background: #f5f5f5;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        .points-modal-title {
            font-weight: bold;
            font-size: 1rem;
        }

        .points-modal-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
        }

        .points-list {
            padding: 10px 0;
        }

        .point-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .point-item:hover {
            background-color: #f9f9f9;
        }

        .point-item:last-child {
            border-bottom: none;
        }

        .point-info {
            display: flex;
            flex-direction: column;
        }

        .point-name {
            font-weight: bold;
            font-size: 0.9rem;
        }

        .point-distance {
            font-size: 0.8rem;
            color: #666;
        }

        .point-status {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-current {
            background: #d4edda;
            color: #155724;
        }

        .toggle-modal-btn {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: #fff;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
        }

        .focus-btn {
            position: fixed;
            bottom: 70px;
            left: 10px;
            background: #fff;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
        }

        .focus-btn:hover, .toggle-modal-btn:hover {
            transform: scale(1.05);
            transition: transform 0.2s;
        }

        .focus-options {
            position: fixed;
            bottom: 130px;
            left: 10px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            width: 200px;
            z-index: 1000;
            font-family: Arial;
            display: none;
            padding: 10px;
        }

        .focus-option {
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 5px;
            transition: background-color 0.2s;
        }

        .focus-option:hover {
            background-color: #f0f0f0;
        }

        .focus-option:last-child {
            margin-bottom: 0;
        }
    </style>

    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
</head>

<body>

    <div id="map"></div>

    <div class="status-box" id="statusBox">
        <div class="header">
            <h3>Navega√ß√£o Tur√≠stica na Regi√£o Norte</h3>
        </div>
        <div class="title">Pr√≥ximo destino:</div>
        <div id="destinoAtual">Carregando...</div>
        <small id="distanciaAtual"></small>
    </div>

    <!-- Bot√£o para abrir/fechar o modal -->
    <button class="toggle-modal-btn" id="toggleModalBtn">üìã</button>

    <!-- Bot√£o para focar nos pontos -->
    <button class="focus-btn" id="focusBtn">üîç</button>

    <!-- Op√ß√µes de foco -->
    <div class="focus-options" id="focusOptions">
        <div class="focus-option" id="focusNext">Focar no Pr√≥ximo Ponto</div>
        <div class="focus-option" id="focusAll">Focar em Todos os Pontos</div>
        <div class="focus-option" id="focusUser">Focar na Minha Localiza√ß√£o</div>
    </div>

    <!-- Modal de pontos selecionados -->
    <div class="points-modal" id="pointsModal">
        <div class="points-modal-header">
            <div class="points-modal-title">Pontos Selecionados</div>
            <button class="points-modal-close" id="closeModalBtn">&times;</button>
        </div>
        <div class="points-list" id="pointsList">
            <!-- Os pontos ser√£o inseridos aqui dinamicamente -->
        </div>
    </div>

    <script>
        // Pegando locais selecionados
        let locais = JSON.parse(localStorage.getItem("selecionados")) || [];

        let atual = 0; // √≠ndice do ponto atual
        let conclu√≠dos = [];
        let userLat = null;
        let userLng = null;

        const statusBox = document.getElementById("statusBox");
        const destinoAtualEl = document.getElementById("destinoAtual");
        const distanciaAtualEl = document.getElementById("distanciaAtual");
        const toggleModalBtn = document.getElementById("toggleModalBtn");
        const pointsModal = document.getElementById("pointsModal");
        const closeModalBtn = document.getElementById("closeModalBtn");
        const pointsList = document.getElementById("pointsList");
        const focusBtn = document.getElementById("focusBtn");
        const focusOptions = document.getElementById("focusOptions");
        const focusNext = document.getElementById("focusNext");
        const focusAll = document.getElementById("focusAll");
        const focusUser = document.getElementById("focusUser");

        // Criar mapa
        const map = L.map('map').setView([-23.31, -51.17], 14);

        // Camada do mapa
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19
        }).addTo(map);

        // √çcone personalizado tipo Uber
        const iconDestino = L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
            iconSize: [40, 40]
        });

        // √çcone usu√°rio
        const iconUser = L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/428/428933.png",
            iconSize: [40, 40]
        });

        // Criar marcadores dos destinos
        let markers = locais.map(loc => {
            return L.marker([loc.lat, loc.lng], { icon: iconDestino })
                .addTo(map)
                .bindPopup(`<b>${loc.nome}</b><br>${loc.descricao}`);
        });

        // ------------------------------
        // FUN√á√ïES DE DIST√ÇNCIA
        // ------------------------------
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI/180;
            const dLon = (lon2 - lon1) * Math.PI/180;

            const a =
                Math.sin(dLat/2) ** 2 +
                Math.cos(lat1 * Math.PI/180) *
                Math.cos(lat2 * Math.PI/180) *
                Math.sin(dLon/2) ** 2;

            return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))) * 1000; // metros
        }

        // Ordenar locais pela dist√¢ncia do usu√°rio
        function ordenarLocais(lat, lng) {
            locais.sort((a, b) => {
                const distA = getDistance(lat, lng, a.lat, a.lng);
                const distB = getDistance(lat, lng, b.lat, b.lng);
                return distA - distB;
            });

            // Atualizar marcadores conforme nova ordem
            markers.forEach(m => map.removeLayer(m));
            markers = locais.map(loc =>
                L.marker([loc.lat, loc.lng], { icon: iconDestino })
                    .addTo(map)
                    .bindPopup(`<b>${loc.nome}</b><br>${loc.descricao}`)
            );

            // Atualizar o modal ap√≥s ordenar
            atualizarModalPontos();
        }

        // ------------------------------
        // DESENHAR ROTA ENTRE OS LOCAIS
        // ------------------------------
        let rotaPolyline = null;

        function desenharRota() {
            if (rotaPolyline) map.removeLayer(rotaPolyline);

            const coords = locais.map(l => [l.lat, l.lng]);

            rotaPolyline = L.polyline(coords, {
                color: "blue",
                weight: 6,
                opacity: 0.7
            }).addTo(map);

            map.fitBounds(rotaPolyline.getBounds());
        }

        // ------------------------------
        // DESTINO ATUAL
        // ------------------------------
        function atualizarDestino() {
            if (atual >= locais.length) {
                destinoAtualEl.textContent = "Todos os locais conclu√≠dos! üéâ";
                distanciaAtualEl.textContent = "";
                return;
            }

            destinoAtualEl.textContent = locais[atual].nome;
        }
        atualizarDestino();

        // ------------------------------
        // FUN√á√ïES DE FOCO
        // ------------------------------
        function focarNoProximoPonto() {
            if (atual < locais.length) {
                const destino = locais[atual];
                map.setView([destino.lat, destino.lng], 16);
                markers[atual].openPopup();
            }
        }

        function focarEmTodosPontos() {
            if (locais.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function focarNaMinhaLocalizacao() {
            if (userLat && userLng) {
                map.setView([userLat, userLng], 16);
            } else {
                alert("Localiza√ß√£o n√£o dispon√≠vel ainda.");
            }
        }

        function focarNoPontoEspecifico(index) {
            if (index >= 0 && index < locais.length) {
                const local = locais[index];
                map.setView([local.lat, local.lng], 16);
                markers[index].openPopup();
            }
        }

        // ------------------------------
        // MODAL DE PONTOS SELECIONADOS
        // ------------------------------
        function atualizarModalPontos() {
            pointsList.innerHTML = '';
            
            locais.forEach((local, index) => {
                const pointItem = document.createElement('div');
                pointItem.className = 'point-item';
                pointItem.dataset.index = index;
                
                const pointInfo = document.createElement('div');
                pointInfo.className = 'point-info';
                
                const pointName = document.createElement('div');
                pointName.className = 'point-name';
                pointName.textContent = local.nome;
                
                const pointDistance = document.createElement('div');
                pointDistance.className = 'point-distance';

                // Calcular dist√¢ncia se temos a localiza√ß√£o do usu√°rio
                if (userLat && userLng) {
                    const distancia = getDistance(userLat, userLng, local.lat, local.lng);
                    pointDistance.textContent = `${(distancia/1000).toFixed(2)} km`;
                } else {
                    pointDistance.textContent = 'Calculando...';
                }
                
                pointInfo.appendChild(pointName);
                pointInfo.appendChild(pointDistance);
                
                const pointStatus = document.createElement('div');
                pointStatus.className = 'point-status';
                
                // Determinar o status do ponto
                if (conclu√≠dos.includes(local)) {
                    pointStatus.textContent = 'Conclu√≠do';
                    pointStatus.classList.add('status-completed');
                } else if (index === atual) {
                    pointStatus.textContent = 'Atual';
                    pointStatus.classList.add('status-current');
                } else {
                    pointStatus.textContent = 'Pendente';
                    pointStatus.classList.add('status-pending');
                }
                
                pointItem.appendChild(pointInfo);
                pointItem.appendChild(pointStatus);
                pointsList.appendChild(pointItem);

                // Adicionar evento de clique para focar no ponto espec√≠fico
                pointItem.addEventListener('click', () => {
                    focarNoPontoEspecifico(index);
                    pointsModal.style.display = 'none';
                });
            });
        }

        // ------------------------------
        // CONTROLE DO MODAL
        // ------------------------------
        toggleModalBtn.addEventListener('click', () => {
            if (pointsModal.style.display === 'block') {
                pointsModal.style.display = 'none';
            } else {
                pointsModal.style.display = 'block';
                atualizarModalPontos();
            }
        });

        closeModalBtn.addEventListener('click', () => {
            pointsModal.style.display = 'none';
        });

        // Fechar modal ao clicar fora dele
        document.addEventListener('click', (event) => {
            if (!pointsModal.contains(event.target) && event.target !== toggleModalBtn) {
                pointsModal.style.display = 'none';
            }
        });

        // ------------------------------
        // CONTROLE DO FOCO
        // ------------------------------
        focusBtn.addEventListener('click', () => {
            if (focusOptions.style.display === 'block') {
                focusOptions.style.display = 'none';
            } else {
                focusOptions.style.display = 'block';
            }
        });

        focusNext.addEventListener('click', () => {
            focarNoProximoPonto();
            focusOptions.style.display = 'none';
        });

        focusAll.addEventListener('click', () => {
            focarEmTodosPontos();
            focusOptions.style.display = 'none';
        });

        focusUser.addEventListener('click', () => {
            focarNaMinhaLocalizacao();
            focusOptions.style.display = 'none';
        });

        // Fechar op√ß√µes de foco ao clicar fora
        document.addEventListener('click', (event) => {
            if (!focusOptions.contains(event.target) && event.target !== focusBtn) {
                focusOptions.style.display = 'none';
            }
        });

        // ------------------------------
        // RASTREAMENTO DO USU√ÅRIO
        // ------------------------------
        let userMarker = null;
        let primeiraLocalizacao = true;

        navigator.geolocation.watchPosition(pos => {
            userLat = pos.coords.latitude;
            userLng = pos.coords.longitude;

            // Atualizar posi√ß√£o do usu√°rio
            if (!userMarker) {
                userMarker = L.marker([userLat, userLng], { icon: iconUser }).addTo(map);
            } else {
                userMarker.setLatLng([userLat, userLng]);
            }

            // Ordena os locais somente na primeira localiza√ß√£o
            if (primeiraLocalizacao) {
                ordenarLocais(userLat, userLng);
                primeiraLocalizacao = false;
            }

            // Dist√¢ncia para o pr√≥ximo ponto
            const destino = locais[atual];
            const dist = getDistance(userLat, userLng, destino.lat, destino.lng);

            distanciaAtualEl.textContent = `Dist√¢ncia: ${(dist/1000).toFixed(2)} km`;

            // Atualizar o modal com as dist√¢ncias atualizadas
            atualizarModalPontos();

            // Se estiver perto, concluir
            if (dist < 80) {
                markers[atual].bindPopup(`<b>${destino.nome}</b><br>‚úîÔ∏è Conclu√≠do`).openPopup();
                conclu√≠dos.push(destino);
                atual++;
                atualizarDestino();

                // Atualizar o modal ap√≥s concluir um ponto
                atualizarModalPontos();

                // Efeito visual
                gsap.fromTo(statusBox, { scale: 1 }, { scale: 1.08, duration: 0.3, yoyo: true, repeat: 1 });
            }

        }, () => {
            alert("Voc√™ precisa permitir o GPS para navegar pelos pontos tur√≠sticos.");
        });

        // Inicializar o modal
        atualizarModalPontos();
    </script>
</body>
</html>